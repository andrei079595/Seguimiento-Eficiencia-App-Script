<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <title>EVA - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'bounce-subtle': 'bounce-subtle 4s ease-in-out infinite',
                    },
                    keyframes: {
                        'bounce-subtle': {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-4px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .dark {
            background-color: #020617;
            color: #f1f5f9;
        }

        /* High-Contrast Dark Mode Overrides */
        .dark .bg-white {
            background-color: #0f172a !important;
        }

        .dark .border-slate-200,
        .dark .border-slate-100 {
            border-color: #1e293b !important;
        }

        .dark h1,
        .dark h2,
        .dark h3,
        .dark h4 {
            color: #f8fafc !important;
        }

        .dark .text-slate-900,
        .dark .text-slate-800,
        .dark .text-slate-700,
        .dark .text-slate-500 {
            color: #f1f5f9 !important;
        }

        .dark .text-slate-600,
        .dark .text-slate-400 {
            color: #94a3b8 !important;
        }

        .dark .bg-slate-50,
        .dark .bg-slate-50/50 {
            background-color: #1e293b !important;
        }

        .dark .hover\:bg-slate-50\/50:hover {
            background-color: #334155 !important;
        }

        .dark th {
            background-color: #1e293b;
            color: #cbd5e1 !important;
        }

        .dark td {
            color: #cbd5e1 !important;
            border-top: 1px solid #1e293b !important;
        }

        .dark .nav-btn {
            color: #f8fafc !important;
        }

        .dark .nav-btn:hover {
            background-color: #1e293b !important;
        }

        .dark .nav-btn.bg-indigo-50 {
            background-color: #312e81 !important;
            color: #e0e7ff !important;
        }

        .dark .filter-chip {
            border-color: #334155;
            color: #94a3b8;
        }

        .dark input,
        .dark textarea {
            background-color: #1e293b !important;
            color: white !important;
            border-color: #334155 !important;
        }

        /* Light Mode Specific Contrast Fixes - TOTAL BLACK */
        body:not(.dark) h1,
        body:not(.dark) h2,
        body:not(.dark) h3,
        body:not(.dark) h4,
        body:not(.dark) .nav-btn,
        body:not(.dark) th:not(.text-white),
        body:not(.dark) td:not(.text-white),
        body:not(.dark) tr:not(.text-white),
        body:not(.dark) span:not(.text-indigo-600):not(.text-emerald-600):not(.text-rose-600):not(.text-white),
        body:not(.dark) .text-slate-900,
        body:not(.dark) .text-slate-800,
        body:not(.dark) .text-slate-700,
        body:not(.dark) .text-slate-600,
        body:not(.dark) .text-slate-500,
        body:not(.dark) .text-slate-400 {
            color: #000000 !important;
            /* Total Black for extreme readability */
            opacity: 1 !important;
        }

        /* Force white on dark headers even in light mode */
        body:not(.dark) tr.bg-indigo-900 th,
        body:not(.dark) .bg-indigo-900 th {
            color: #ffffff !important;
        }

        /* Chart background color adjustment */
        body:not(.dark) .bg-white,
        body:not(.dark) canvas {
            background-color: #ffffff !important;
        }

        /* High Contrast Theme Tokens */
        .dark .bg-white {
            background-color: #0f172a !important;
        }

        .dark .border-slate-200 {
            border-color: #1e293b !important;
        }

        .dark .text-slate-400 {
            color: #64748b !important;
        }

        body:not(.dark) .bg-slate-50\/50 {
            background-color: #f8fafc !important;
        }

        body:not(.dark) .border-slate-100 {
            border-color: #e2e8f0 !important;
        }

        /* Gantt Milestone Flag - Restored to Rows */
        .gantt-flag {
            position: absolute;
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            line-height: 1;
        }

        .gantt-flag:hover {
            transform: translateX(-50%) scale(1.3);
        }

        @keyframes bounce-subtle {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-4px);
            }
        }

        .animate-bounce-subtle {
            animation: bounce-subtle 4s ease-in-out infinite;
        }

        /* Gantt Visualization Styles */
        .gantt-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .dark .gantt-row {
            border-color: #1e293b;
        }

        .gantt-lines-container {
            flex: 1;
            position: relative;
            height: 60px;
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 12px;
        }

        .gantt-line-expected {
            position: absolute;
            top: 20px;
            left: 0;
            height: 6px;
            background: #818cf8;
            border-radius: 3px;
            z-index: 1;
            width: 100%;
        }

        .gantt-line-materialized {
            position: absolute;
            top: 40px;
            left: 0;
            height: 6px;
            background: #34d399;
            border-radius: 3px;
            z-index: 2;
            transition: width 0.3s ease;
        }

        .gantt-value-top {
            position: absolute;
            top: 5px;
            width: 100%;
            text-align: center;
            font-size: 8px;
            font-weight: 800;
            color: #6366f1;
        }

        .gantt-value-bottom {
            position: absolute;
            top: 52px;
            width: 100%;
            text-align: center;
            font-size: 8px;
            font-weight: 800;
            color: #10b981;
        }

        .line-segment {
            position: relative;
            height: 100%;
        }

        .shaded {
            opacity: 0.2;
        }

        #loading-overlay {
            background: #ffffff;
            backdrop-filter: blur(8px);
        }

        .dark #loading-overlay {
            background: #020617;
        }

        /* Toast Notification Styles */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #1e1b4b;
            color: #fff;
            text-align: center;
            border-radius: 12px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            /* Increased to be above everything */
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            font-weight: bold;
            font-size: 14px;
            border: 1px solid #4338ca;
            white-space: pre-wrap;
            /* Support multi-line hito lists */
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }

        /* Initiative Detail Popover */
        .init-popover {
            position: absolute;
            z-index: 100;
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            width: 320px;
            border: 1px solid #e2e8f0;
            display: none;
            pointer-events: auto;
        }

        .dark .init-popover {
            background: #1e293b;
            border-color: #334155;
            color: #f1f5f9;
        }

        .popover-arrow {
            position: absolute;
            width: 12px;
            height: 12px;
            background: inherit;
            border: inherit;
            border-top: none;
            border-left: none;
            transform: rotate(45deg);
            bottom: -6px;
            left: 50%;
            margin-left: -6px;
        }

        .vpe-gantt-group {
            margin-top: 2rem;
            border-top: 2px solid #818cf8;
            padding-top: 1rem;
        }

        .vpe-gantt-vpe-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1.5rem;
            background: #f1f5f9;
            border-radius: 1rem;
            margin-bottom: 1rem;
            font-weight: 900;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .dark .vpe-gantt-vpe-header {
            background: #1e293b;
            color: #f1f5f9;
        }

        /* Unified Gantt Grid Architecture */
        .gantt-grid-system {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 0.5rem;
        }

        .gantt-row-container {
            display: flex;
            align-items: center;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }

        .gantt-label-box {
            width: var(--gantt-label-w, 400px);
            flex-shrink: 0;
            padding-right: 1rem;
            display: flex;
            align-items: center;
            font-size: var(--gantt-font-size, 14px);
        }

        :root {
            --gantt-label-w: 420px;
            --gantt-font-size: 15px;
        }

        @media (max-width: 1400px) {
            :root {
                --gantt-label-w: 300px;
                --gantt-font-size: 13px;
            }
        }

        @media (max-width: 1200px) {
            :root {
                --gantt-label-w: 240px;
                --gantt-font-size: 11px;
            }
        }

        /* Removed redundant scroll wrappers */

        /* Collapsible Sidebar Styles */
        #sidebar.collapsed {
            width: 80px;
        }

        #sidebar.collapsed .sidebar-text,
        #sidebar.collapsed #user-greeting,
        #sidebar.collapsed .sidebar-logo-text {
            display: none;
        }

        #sidebar.collapsed .nav-btn {
            justify-content: center;
            padding-left: 0;
            padding-right: 0;
        }

        #sidebar.collapsed .nav-btn svg {
            margin-right: 0;
        }

        #sidebar.collapsed .mt-auto {
            padding: 1.5rem 0;
            display: flex;
            justify-content: center;
        }

        #sidebar.collapsed #dark-mode-text {
            display: none;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen dark">
    <div id="loading-overlay" class="fixed inset-0 z-50 flex items-center justify-center">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
            <p class="font-bold tracking-tight">Cargando EVA...</p>
        </div>
    </div>
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar Navigation -->
        <aside id="sidebar"
            class="w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col shrink-0 transition-all duration-300 relative">
            <div class="p-6">
                <div class="flex items-center justify-between mb-10 ml-2">
                    <div class="flex items-center gap-3 sidebar-logo-text">
                        <img src="https://i.ibb.co/G4SV5ckh/unnamed-1.png" alt="EVA Logo" class="h-10">
                    </div>
                    <button onclick="toggleSidebar()"
                        class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg text-slate-400">
                        <svg id="sidebar-toggle-icon" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
                        </svg>
                    </button>
                </div>
                <nav class="space-y-2">
                    <button id="btn-vpe" onclick="switchView('vpe')"
                        class="nav-btn w-full flex items-center px-4 py-3 text-sm font-bold rounded-xl transition-all">
                        <svg class="h-5 w-5 mr-3 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                        </svg>
                        <span class="sidebar-text">Resumen Ejecutivo</span>
                    </button>
                    <button id="btn-initiatives" onclick="switchView('initiatives')"
                        class="nav-btn w-full flex items-center px-4 py-3 text-sm font-bold rounded-xl transition-all">
                        <svg class="h-5 w-5 mr-3 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        <span class="sidebar-text">Iniciativas</span>
                    </button>
                </nav>
            </div>
            <div class="mt-auto p-6">
                <button onclick="toggleDarkMode()"
                    class="w-full flex items-center justify-between px-4 py-2 text-xs font-black uppercase tracking-widest text-slate-400 bg-slate-50 dark:bg-slate-800 rounded-lg">
                    <span id="dark-mode-text">Modo DÃ­a</span>
                    <svg id="moon-icon" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z" />
                    </svg>
                </button>
            </div>
        </aside>
        <!-- Main Workspace -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header
                class="h-16 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-8 shrink-0">
                <h1 id="view-title" class="text-xl font-black text-slate-900 dark:text-white tracking-tight uppercase">
                    Cargando...</h1>
                <div class="flex items-center gap-4">
                    <p id="user-greeting" class="text-sm font-medium text-slate-500">Hola, <span
                            class="text-indigo-600">---</span></p>
                    <div id="user-initial"
                        class="h-8 w-8 rounded-full bg-indigo-600 text-white flex items-center justify-center font-black shadow-lg">
                        U</div>
                </div>
            </header>
            <div id="views-container" class="flex-1 overflow-y-auto p-8 bg-slate-50/50 dark:bg-slate-950">
                <!-- View: EXECUTIVE SUMMARY (VPE) -->
                <section id="view-vpe" class="view space-y-8">
                    <!-- Top KPI Card -->
                    <!-- Top KPI Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Full Row: Global Filters -->
                        <div
                            class="bg-white dark:bg-slate-900 p-8 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-xl dark:shadow-indigo-500/5 col-span-1 md:col-span-3 flex flex-col gap-8">
                            <div class="space-y-4 flex-1">
                                <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest">Filtros Globales
                                </h4>
                                <div id="vpe-category-filters" class="flex flex-wrap gap-2"></div>
                            </div>
                            <div class="space-y-4 flex-1">
                                <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest">VPE</h4>
                                <div id="vpe-vpe-filters" class="flex flex-wrap gap-2"></div>
                            </div>
                            <div class="space-y-4 flex-1">
                                <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest">Frente</h4>
                                <div id="vpe-frente-filters" class="flex flex-wrap gap-2"></div>
                            </div>
                            <div id="exec-toggle-container" class="hidden shrink-0">
                                <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Vista de
                                    Datos</h4>
                                <div class="flex p-1 bg-slate-100 dark:bg-slate-800 rounded-xl w-fit">
                                    <button id="toggle-team" onclick="setExecToggle('team')"
                                        class="px-4 py-2 text-[10px] font-black rounded-lg transition-all uppercase tracking-tighter">Mi
                                        Equipo</button>
                                    <button id="toggle-all" onclick="setExecToggle('all')"
                                        class="px-4 py-2 text-[10px] font-black rounded-lg transition-all uppercase tracking-tighter">Toda
                                        la Base</button>
                                </div>
                            </div>
                            <div
                                class="flex items-end justify-between gap-4 mt-4 pt-6 border-t border-slate-100 dark:border-slate-800">
                                <div class="space-y-4 flex-1">
                                    <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest">Responsable
                                        Primario</h4>
                                    <div id="vpe-responsable-filters" class="flex flex-wrap gap-2"></div>
                                </div>
                                <button onclick="triggerExportToSheets()"
                                    class="px-6 py-2.5 bg-emerald-600 text-white text-xs font-black rounded-xl shadow-lg hover:bg-emerald-700 transition-all uppercase tracking-widest flex items-center gap-2 mb-1">
                                    <span>ðŸ“Š</span> Exportar a Sheets
                                </button>
                            </div>
                        </div>

                        <!-- 3-Column Row: KPI Cards -->
                        <div
                            class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-xl dark:shadow-indigo-500/5">
                            <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Total
                                Eficiencia Identificada</h4>
                            <span id="pot-total-exec"
                                class="text-4xl font-black text-indigo-400 tracking-tighter">$0M</span>
                        </div>
                        <div
                            class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-xl dark:shadow-indigo-500/5">
                            <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Total
                                Eficiencia Materializada</h4>
                            <span id="mat-total-exec"
                                class="text-4xl font-black text-emerald-500 tracking-tighter">$0M</span>
                        </div>
                        <div
                            class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-xl dark:shadow-indigo-500/5">
                            <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Materializado
                                PYG</h4>
                            <span id="pyg-total" class="text-4xl font-black text-indigo-600 tracking-tighter">$0M</span>
                        </div>
                    </div>
                    <!-- Charts Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div
                            class="bg-white dark:bg-slate-900 p-8 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-xl flex flex-col h-[450px]">
                            <h3
                                class="text-sm font-black mb-6 uppercase tracking-widest text-slate-500 dark:text-slate-400">
                                Eficiencia
                                por Qs Esperada ($M)</h3>
                            <div class="flex-1 relative">
                                <canvas id="vpe-quarter-chart"></canvas>
                            </div>
                        </div>
                        <div
                            class="bg-white dark:bg-slate-900 p-8 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-xl flex flex-col h-[450px]">
                            <h3
                                class="text-sm font-black mb-6 uppercase tracking-widest text-slate-500 dark:text-slate-400">
                                DistribuciÃ³n
                                Eficiencia potencial por VPE</h3>
                            <div class="flex-1 relative">
                                <canvas id="vpe-pie-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- VPE Table -->
                    <div id="vpe-summary-section"
                        class="bg-white dark:bg-slate-900 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-xl overflow-hidden mt-8 transition-all duration-300">
                        <div
                            class="p-6 cursor-pointer flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/20 hover:bg-slate-100 dark:hover:bg-slate-800 transition-all border-b border-slate-200 dark:border-slate-800">
                            <div>
                                <h3 onclick="toggleAccordion('vpe-summary-content', 'vpe-summary-icon')"
                                    class="text-xl font-black uppercase tracking-tight">Resumen por VPE</h3>
                                <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mt-1">VisiÃ³n
                                    consolidada de metas y ahorros</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <svg id="vpe-summary-icon"
                                    onclick="toggleAccordion('vpe-summary-content', 'vpe-summary-icon')"
                                    class="w-6 h-6 transition-transform rotate-180" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                        d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                        <div id="vpe-summary-content" class="overflow-x-auto">
                            <table class="w-full text-left text-sm min-w-[1200px]">
                                <thead class="bg-slate-50 dark:bg-slate-900/50 border-b border-slate-200">
                                    <tr>
                                        <th rowspan="2"
                                            class="px-8 py-6 font-black uppercase text-[12px] text-slate-900 dark:text-slate-100 border-r border-slate-200 dark:border-slate-800 bg-slate-100/50 dark:bg-slate-900/80">
                                            VPE</th>
                                        <th rowspan="2"
                                            class="px-6 py-6 font-black uppercase text-[12px] text-slate-900 dark:text-slate-100 border-r border-slate-200 dark:border-slate-800 text-center bg-slate-100/50 dark:bg-slate-900/80">
                                            Meta ($M)</th>
                                        <th colspan="3"
                                            class="px-4 py-4 font-black uppercase text-[12px] text-indigo-700 dark:text-indigo-400 border-b border-indigo-100 dark:border-indigo-900/40 text-center bg-indigo-100/30 dark:bg-indigo-900/20">
                                            Oportunidad $ MM</th>
                                        <th rowspan="2"
                                            class="px-6 py-6 font-black uppercase text-[12px] text-slate-900 dark:text-slate-100 border-r border-slate-200 dark:border-slate-800 text-center bg-slate-100/50 dark:bg-slate-900/80">
                                            <div class="flex flex-col items-center gap-1">
                                                <span class="text-2xl">ðŸ‘¥</span>
                                                <span class="leading-none text-[12px]">FTEs</span>
                                            </div>
                                        </th>
                                        <th colspan="4"
                                            class="px-4 py-4 font-black uppercase text-[12px] text-emerald-700 dark:text-emerald-400 border-b border-emerald-100 dark:border-emerald-900/40 text-center bg-emerald-100/30 dark:bg-indigo-900/20">
                                            DistribuciÃ³n 2026</th>
                                    </tr>
                                    <tr>
                                        <!-- Oportunidad deslose (REORDERED) -->
                                        <th
                                            class="px-4 py-4 font-black uppercase text-[10px] text-slate-500 dark:text-slate-400 text-center border-r border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900">
                                            M.Ext.</th>
                                        <th
                                            class="px-4 py-4 font-black uppercase text-[10px] text-slate-500 dark:text-slate-400 text-center border-r border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900">
                                            G.Person.</th>
                                        <th
                                            class="px-4 py-4 font-black uppercase text-[10px] text-indigo-700 dark:text-indigo-400 text-center border-r border-slate-200 dark:border-slate-800 bg-indigo-50 dark:bg-indigo-950/20">
                                            Total</th>
                                        <!-- Trimesters -->
                                        <th
                                            class="px-6 py-4 font-black uppercase text-[10px] text-slate-500 dark:text-slate-400 text-center border-r border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900">
                                            Q1</th>
                                        <th
                                            class="px-6 py-4 font-black uppercase text-[10px] text-slate-500 dark:text-slate-400 text-center border-r border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900">
                                            Q2</th>
                                        <th
                                            class="px-6 py-4 font-black uppercase text-[10px] text-slate-500 dark:text-slate-400 text-center border-r border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900">
                                            Q3</th>
                                        <th
                                            class="px-6 py-4 font-black uppercase text-[10px] text-slate-500 dark:text-slate-400 text-center bg-slate-50 dark:bg-slate-900">
                                            Q4</th>
                                    </tr>
                                </thead>
                                <tbody id="vpe-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- VPE Gantt Section -->
                    <div id="vpe-gantt-section"
                        class="bg-white dark:bg-slate-900 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-xl mt-8 relative transition-all duration-300">
                        <div onclick="toggleAccordion('vpe-gantt-content', 'vpe-gantt-icon')"
                            class="p-8 cursor-pointer flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/20 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-t-3xl transition-all">
                            <div>
                                <h3 class="text-xl font-black uppercase tracking-tight">Cronograma por VPE e Iniciativa
                                </h3>
                                <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mt-1 italic">
                                    Haz clic en el nombre de la iniciativa para ver detalles</p>
                            </div>
                            <svg id="vpe-gantt-icon" class="w-6 h-6 transition-transform rotate-180" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                        <div id="vpe-gantt-content" class="p-8">
                            <div class="flex justify-end mb-6">
                                <button onclick="openVpePdfModal()"
                                    class="px-6 py-2.5 bg-rose-600 text-white text-xs font-black rounded-xl shadow-lg hover:bg-rose-700 transition-all uppercase tracking-widest flex items-center gap-2">
                                    <span>ðŸ“„</span> Exportar a PDF
                                </button>
                            </div>
                            <div id="vpe-gantt-container" class="space-y-4"></div>
                        </div>
                        <!-- Initiative Detail Popover -->
                        <div id="init-detail-popover" class="init-popover">
                            <div class="popover-arrow"></div>
                            <div class="flex justify-between items-start mb-4">
                                <h4 id="pop-init-name" class="text-sm font-black leading-tight"></h4>
                                <button onclick="document.getElementById('init-detail-popover').style.display='none'"
                                    class="text-slate-400 hover:text-rose-500 font-black px-2">âœ•</button>
                            </div>
                            <div class="space-y-3 relative pl-4 border-l-2 border-slate-100 dark:border-slate-800">
                                <p class="text-[8px] font-black uppercase text-slate-400 mb-2">PrÃ³ximos Hitos</p>
                                <div id="pop-init-hitos" class="space-y-3 max-h-40 overflow-y-auto pr-2"></div>
                            </div>
                        </div>
                </section>
                <!-- View: INITIATIVES & GANTT -->
                <section id="view-initiatives" class="view hidden space-y-6">
                    <!-- Initiatives Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div
                            class="bg-white dark:bg-slate-900 p-5 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm">
                            <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Iniciativas
                                Filtradas</h4>
                            <span id="count-init"
                                class="text-3xl font-black text-slate-800 dark:text-white items-baseline">0</span>
                        </div>
                        <div
                            class="bg-white dark:bg-slate-900 p-5 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm">
                            <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Potencial
                                ($M)</h4>
                            <span id="pot-init" class="text-2xl font-black text-indigo-600">$0M</span>
                        </div>
                        <div
                            class="bg-white dark:bg-slate-900 p-5 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm">
                            <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">
                                Materializado ($M)</h4>
                            <span id="mat-init" class="text-2xl font-black text-emerald-500">$0M</span>
                        </div>
                        <div
                            class="bg-white dark:bg-slate-900 p-5 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm border-indigo-200/50">
                            <h4 class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-1">Potencial
                                (FTEs)</h4>
                            <span id="pot-fte-init" class="text-2xl font-black text-indigo-400">0.0</span>
                        </div>
                        <div
                            class="bg-white dark:bg-slate-900 p-5 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm border-emerald-200/50">
                            <h4 class="text-[10px] font-black text-emerald-400 uppercase tracking-widest mb-1">
                                Materializado (FTEs)</h4>
                            <span id="mat-fte-init" class="text-2xl font-black text-emerald-400">0.0</span>
                        </div>
                    </div>
                    <!-- Filters Panel -->
                    <div
                        class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm space-y-6">
                        <div id="resp-filter-section" class="hidden">
                            <label
                                class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Responsable
                                Primario</label>
                            <div id="responsable-filters" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div id="vpe-filter-parent">
                            <label
                                class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-3">VPE</label>
                            <div id="vpe-filters" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div>
                            <label
                                class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Frente</label>
                            <div id="frente-filters" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                            <div id="category-filter-section" class="flex-1">
                                <label
                                    class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Fuente
                                    de Eficiencia (Manos Extendidas vs Gasto de Personal)</label>
                                <div id="init-category-filters" class="flex flex-wrap gap-2"></div>
                            </div>
                            <div id="init-toggle-container"
                                class="hidden shrink-0 border-l border-slate-100 dark:border-slate-800 pl-6">
                                <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Vista de
                                    Datos</h4>
                                <div class="flex p-1 bg-slate-100 dark:bg-slate-800 rounded-xl w-fit">
                                    <button id="toggle-team-init" onclick="setExecToggle('team')"
                                        class="px-4 py-2 text-[10px] font-black rounded-lg transition-all uppercase tracking-tighter">Mi
                                        Equipo</button>
                                    <button id="toggle-all-init" onclick="setExecToggle('all')"
                                        class="px-4 py-2 text-[10px] font-black rounded-lg transition-all uppercase tracking-tighter">Toda
                                        la Base</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- New Chart Section for Initiatives -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div
                            class="bg-white dark:bg-slate-900 p-8 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-xl flex flex-col h-[400px]">
                            <h3 class="text-sm font-black mb-6 uppercase tracking-widest text-slate-500">Eficiencia
                                por Qs Esperada ($M) - Filtrado</h3>
                            <div class="flex-1 relative">
                                <canvas id="init-quarter-chart"></canvas>
                            </div>
                        </div>
                        <div
                            class="bg-white dark:bg-slate-900 p-8 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-xl flex flex-col h-[400px]">
                            <h3 class="text-sm font-black mb-6 uppercase tracking-widest text-slate-500">Potenciales por
                                iniciativa</h3>
                            <div class="flex-1 relative">
                                <canvas id="init-pie-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Initiatives Data Table -->
                    <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm min-w-[1000px]">
                                <thead>
                                    <tr class="bg-indigo-900 text-white border-b border-indigo-800">
                                        <th
                                            class="px-6 py-4 font-black uppercase text-[10px] tracking-widest text-left min-w-[300px]">
                                            Iniciativa</th>
                                        <th
                                            class="px-4 py-4 font-black uppercase text-[10px] tracking-widest text-left">
                                            CÃ³d</th>
                                        <th
                                            class="px-4 py-4 font-black uppercase text-[10px] tracking-widest text-left">
                                            Tipo</th>
                                        <th
                                            class="px-4 py-4 font-black uppercase text-[10px] tracking-widest text-left">
                                            VPE</th>
                                        <th
                                            class="px-4 py-4 font-black uppercase text-[10px] tracking-widest text-left">
                                            Responsable</th>
                                        <th
                                            class="px-4 py-4 font-black uppercase text-[10px] tracking-widest text-right">
                                            Pot. ($)</th>
                                        <th
                                            class="px-4 py-4 font-black uppercase text-[10px] tracking-widest text-right">
                                            Pot. (FTE)</th>
                                        <th
                                            class="px-4 py-4 font-black uppercase text-[10px] tracking-widest text-right">
                                            Mat. ($)</th>
                                        <th
                                            class="px-4 py-4 font-black uppercase text-[10px] tracking-widest text-right">
                                            Mat. (FTE)</th>
                                        <th
                                            class="px-4 py-4 font-black uppercase text-[10px] tracking-widest text-center">
                                            % Avance</th>
                                        <th
                                            class="px-4 py-4 font-black uppercase text-[10px] tracking-widest text-center">
                                            Hitos</th>
                                        <th
                                            class="px-4 py-4 font-black uppercase text-[10px] tracking-widest text-center">
                                            Seguimiento</th>
                                    </tr>
                                </thead>
                                <tbody id="initiatives-table-body"
                                    class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Gantt Timeline Section -->
                    <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm relative">
                        <div class="flex justify-between items-start mb-10">
                            <h3 class="text-xl font-black uppercase tracking-tight">Cronograma de EjecuciÃ³n Mensual
                                ($M)</h3>
                            <div class="flex items-center gap-4">
                                <select id="gantt-init-filter"
                                    onchange="appData.ganttFilter = this.value; buildInitiativesView();"
                                    class="bg-slate-50 dark:bg-slate-800 border-none rounded-xl px-4 py-2 text-xs font-black text-indigo-600 outline-none focus:ring-2 ring-indigo-500 transition-all max-w-[200px]">
                                    <option value="all">TODAS LAS INICIATIVAS</option>
                                </select>
                                <div
                                    class="flex items-center gap-6 px-4 py-2 bg-slate-50 dark:bg-slate-800/50 rounded-2xl border border-slate-100 dark:border-slate-800">
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 rounded-full bg-indigo-400"></div>
                                        <span
                                            class="text-[10px] font-black uppercase tracking-widest text-slate-500">Esperado</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 rounded-full bg-emerald-400"></div>
                                        <span
                                            class="text-[10px] font-black uppercase tracking-widest text-slate-500">Materializado</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm">ðŸš©</span>
                                        <span
                                            class="text-[10px] font-black uppercase tracking-widest text-slate-500">Hitos</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="gantt-container" class="space-y-6"></div>
                </section>
            </div>
        </main>
    </div>
    <!-- PDF Selection Modal -->
    <div id="pdf-modal" onclick="if(event.target === this) document.getElementById('pdf-modal').classList.add('hidden')"
        class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black/80 backdrop-blur-md">
        <div
            class="bg-white dark:bg-slate-900 w-full max-w-2xl rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-200 dark:border-slate-800 animate-fade-in pointer-events-auto">
            <div class="p-8 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-black uppercase tracking-tight">Exportar Resumen PDF</h3>
                    <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mt-1">Selecciona las VPEs
                        que deseas incluir en el reporte</p>
                </div>
                <button onclick="document.getElementById('pdf-modal').classList.add('hidden')"
                    class="h-10 w-10 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-all text-slate-400 font-bold">âœ•</button>
            </div>
            <div id="vpe-selection-list" class="p-8 grid grid-cols-2 gap-4 max-h-[400px] overflow-y-auto"></div>
            <div class="p-8 bg-slate-50 dark:bg-slate-900/50 flex justify-end gap-4">
                <button onclick="document.getElementById('pdf-modal').classList.add('hidden')"
                    class="px-8 py-3 text-xs font-black uppercase tracking-widest text-slate-500 hover:text-slate-700">Cancelar</button>
                <button onclick="generatePDF()"
                    class="px-8 py-3 bg-indigo-600 text-white text-xs font-black rounded-2xl shadow-lg hover:bg-indigo-700 transition-all uppercase tracking-widest">Generar
                    Reporte</button>
            </div>
        </div>
    </div>

    <!-- Milestones Modal -->
    <div id="hitos-modal" onclick="if(event.target === this) closeHitosModal()"
        class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black/80 backdrop-blur-md cursor-pointer">
        <div
            class="bg-white dark:bg-slate-900 w-full max-w-2xl p-8 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-2xl overflow-hidden flex flex-col max-h-[80vh] cursor-default">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-2xl font-black mb-1">Hitos de la Iniciativa</h3>
                    <p id="hitos-subtitle" class="text-indigo-600 text-[10px] uppercase font-black tracking-widest"></p>
                </div>
                <button onclick="closeHitosModal()"
                    class="p-3 bg-slate-100 dark:bg-slate-800 hover:bg-rose-500 hover:text-white rounded-xl transition-all font-black">âœ•
                    CERRAR</button>
            </div>
            <div id="hitos-timeline" class="flex-1 overflow-y-auto pr-4 space-y-6 relative">
                <!-- Timeline vertical line -->
                <div class="absolute left-[15px] top-0 bottom-0 w-0.5 bg-indigo-100 dark:bg-indigo-900/30"></div>
                <div id="hitos-list" class="space-y-8 relative"></div>
            </div>
        </div>
    </div>
    <!-- Observation Modal -->
    <div id="obs-modal" onclick="if(event.target === this) closeModal()"
        class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black/80 backdrop-blur-md cursor-pointer">
        <div
            class="bg-white dark:bg-slate-900 w-full max-w-md p-8 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-2xl cursor-default">
            <h3 class="text-2xl font-black mb-1">Registrar ObservaciÃ³n</h3>
            <p id="modal-subtitle" class="text-indigo-600 text-[10px] mb-6 uppercase font-black tracking-widest"></p>
            <textarea id="obs-text"
                class="w-full h-40 p-4 bg-slate-50 dark:bg-slate-800 border-none rounded-2xl outline-none focus:ring-2 ring-indigo-500 dark:text-white transition-all resize-none"
                placeholder="Escribe aquÃ­ el seguimiento de esta iniciativa..."></textarea>
            <div class="flex justify-end gap-3 mt-8">
                <button onclick="closeModal()"
                    class="px-6 py-3 text-sm font-bold text-slate-400 hover:text-slate-600 transition-all">Cancelar</button>
                <button onclick="saveObservation()"
                    class="px-8 py-3 bg-indigo-600 text-white font-black rounded-2xl hover:bg-indigo-700 shadow-lg shadow-indigo-600/20 transition-all">Guardar
                    ObservaciÃ³n</button>
            </div>
        </div>
    </div>
    </div>
    <!-- Toast Notification -->
    <div id="toast"></div>
    <script>
        let appData = {
            user: {}, baseData: [], goals: [], milestones: [],
            vpeFilters: new Set(), respFilters: new Set(), catFilters: new Set(), frenteFilters: new Set(),
            execViewToggle: 'all', ganttFilter: 'all'
        };
        const fmt = (v) => {
            const val = parseFloat(v) || 0;
            return (val / 1000000).toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 0, useGrouping: true });
        };
        let currentModalData = null;
        let vpeChartInstance = null, vpePieChartInstance = null;
        let initQChartInstance = null, initPieChartInstance = null;
        window.onload = () => {
            google.script.run
                .withSuccessHandler(data => {
                    try {
                        if (!data) throw new Error("No se recibieron datos del servidor.");
                        appData.user = data.user || {};
                        appData.headers = data.headers || [];
                        appData.baseData = (data.baseData || []).filter(r => r && Array.isArray(r));
                        appData.goals = (data.goals || []).filter(r => r && Array.isArray(r));
                        appData.milestones = (data.milestones || []).filter(r => r && Array.isArray(r));
                        // Default view for Profile 2 is 'team'
                        if (appData.user.perfil == 2) appData.execViewToggle = 'team';
                        initApp();
                    } catch (e) {
                        handleFatalError(e);
                    }
                })
                .withFailureHandler(err => {
                    handleFatalError(err);
                })
                .getInitialData();
        };
        function handleFatalError(err) {
            console.error("Fatal Error:", err);
            const overlay = document.getElementById('loading-overlay');
            overlay.innerHTML = `
                <div class="bg-white dark:bg-slate-900 p-8 rounded-3xl border border-rose-200 dark:border-rose-900/30 shadow-2xl max-w-md text-center">
                    <div class="text-4xl mb-4">âš ï¸</div>
                    <h3 class="text-xl font-black text-rose-600 mb-2">Error de Carga</h3>
                    <p class="text-sm text-slate-500 mb-6">${err.message || 'OcurriÃ³ un error inesperado al inicializar la aplicaciÃ³n.'}</p>
                    <button onclick="location.reload()" class="px-6 py-2 bg-slate-100 dark:bg-slate-800 font-bold rounded-xl hover:bg-slate-200 transition-all">Reintentar</button>
                </div>
            `;
            overlay.classList.remove('hidden');
        }
        function initApp() {
            try {
                document.body.classList.add('dark'); // Force dark mode by default
                document.getElementById('loading-overlay').classList.add('hidden');
                if (!appData.user || !appData.user.nombre) {
                    console.warn("User data missing");
                }
                document.getElementById('user-greeting').innerHTML = `Hola, <span class="text-indigo-600 font-bold">${appData.user.nombre || 'Usuario'}</span>`;
                document.getElementById('user-initial').innerText = (appData.user.nombre || "U").charAt(0);
                // Profile 2 Switch Visibility (Apply to both versions)
                if (appData.user.perfil == 2) {
                    document.getElementById('exec-toggle-container').classList.remove('hidden');
                    document.getElementById('init-toggle-container').classList.remove('hidden');
                    updateToggleUI();
                }
                if (appData.user.perfil == 3) {
                    document.getElementById('btn-vpe').classList.add('hidden');
                    switchView('initiatives');
                } else {
                    const respSection = document.getElementById('resp-filter-section');
                    if (respSection) respSection.classList.remove('hidden');
                    switchView('vpe');
                }
            } catch (e) {
                handleFatalError(e);
            }
        }
        function setExecToggle(val) {
            appData.execViewToggle = val;
            updateToggleUI();
            buildVPEView();
            buildInitiativesView();
        }
        function updateToggleUI() {
            const isTeam = appData.execViewToggle === 'team';
            const targets = [
                { team: 'toggle-team', all: 'toggle-all' },
                { team: 'toggle-team-init', all: 'toggle-all-init' }
            ];
            targets.forEach(ids => {
                const btnTeam = document.getElementById(ids.team);
                const btnAll = document.getElementById(ids.all);
                if (!btnTeam || !btnAll) return;
                if (isTeam) {
                    btnTeam.className = "px-4 py-2 text-[10px] font-black rounded-lg transition-all uppercase tracking-tighter bg-indigo-600 text-white shadow-md";
                    btnAll.className = "px-4 py-2 text-[10px] font-black rounded-lg transition-all uppercase tracking-tighter text-slate-400 hover:text-indigo-500";
                } else {
                    btnAll.className = "px-4 py-2 text-[10px] font-black rounded-lg transition-all uppercase tracking-tighter bg-indigo-600 text-white shadow-md";
                    btnTeam.className = "px-4 py-2 text-[10px] font-black rounded-lg transition-all uppercase tracking-tighter text-slate-400 hover:text-indigo-500";
                }
            });
        }
        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-indigo-50', 'text-indigo-700', 'ring-2', 'ring-indigo-100'));
            const activeView = document.getElementById(`view-${viewId}`);
            if (activeView) activeView.classList.remove('hidden');
            const btn = document.getElementById(`btn-${viewId}`);
            if (btn) btn.classList.add('bg-indigo-50', 'text-indigo-700', 'ring-2', 'ring-indigo-100');
            const titles = { 'vpe': 'Cuadro de Mando Ejecutivo', 'initiatives': 'GestiÃ³n de Iniciativas', 'detail': 'Panel de Detalle' };
            document.getElementById('view-title').innerText = titles[viewId] || 'EVA';
            if (viewId === 'vpe') buildVPEView();
            if (viewId === 'initiatives') buildInitiativesView();
        }
        const findIdx = (keywords, fallback, exactMatch = false) => {
            const h = appData.headers || [];
            const months = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
            if (exactMatch) {
                const eIdx = h.findIndex(hdr => hdr && keywords.some(k => hdr.toLowerCase() === k.toLowerCase()));
                if (eIdx !== -1) return eIdx;
            }
            const tIdx = h.findIndex(hdr => {
                if (!hdr) return false;
                const lower = hdr.toLowerCase();
                return keywords.every(k => lower.includes(k.toLowerCase())) && (lower.includes('total') || lower.includes('consolidado') || lower.includes('cierre'));
            });
            if (tIdx !== -1) return tIdx;
            const sIdx = h.findIndex(hdr => {
                if (!hdr) return false;
                const lower = hdr.toLowerCase();
                const hasKeywords = keywords.every(k => lower.includes(k.toLowerCase()));
                const hasMonth = months.some(m => lower.includes(m));
                return hasKeywords && !hasMonth;
            });
            if (sIdx !== -1) return sIdx;
            const idx = h.findIndex(hdr => hdr && keywords.every(k => hdr.toLowerCase().includes(k.toLowerCase())));
            return idx === -1 ? fallback : idx;
        };
        function buildVPEView() {
            const tbody = document.getElementById('vpe-table-body');
            tbody.innerHTML = '';
            const vpeMap = {};
            const potIdx = findIdx(['total eficiencia identificada', 'potencial ($)'], 18);
            const matIdx = findIdx(['materializado ($)'], 80);
            const catIdx = findIdx(['categoria', 'fuente', 'manos'], 6);
            const vpeIdx = findIdx(['vpe'], 3);
            const deptIdx = findIdx(['departamento', 'equipo'], 4);
            const fteIdx = findIdx(['potencial (fte)'], 17);
            const metaIdx = findIdx(['meta'], 1);
            const pygIdx = 89; // PyG Index

            appData.goals.slice(1).forEach(row => {
                if (row && row[0]) {
                    vpeMap[String(row[0]).trim()] = {
                        meta: parseFloat(row[1]) || 0,
                        pot: 0,
                        mat: 0,
                        manos: 0,
                        personal: 0,
                        fte: 0,
                        q1: 0, q2: 0, q3: 0, q4: 0
                    };
                }
            });

            const filteredBase = appData.baseData.filter(row => {
                if (!row) return false;
                if (appData.user.perfil == 2 && appData.execViewToggle === 'team') {
                    const rowDept = row[deptIdx] ? String(row[deptIdx]).trim().toLowerCase() : '';
                    const userDept = appData.user.departamento ? String(appData.user.departamento).trim().toLowerCase() : '';
                    const isOwnTeam = (rowDept === userDept) || (appData.user.deptUsers || []).some(u =>
                        [row[14], row[15], row[16]].some(r => r && String(r).trim() === String(u).trim())
                    );
                    if (!isOwnTeam) return false;
                }
                const vpeName = row[vpeIdx] ? String(row[vpeIdx]).trim() : '';
                const passVpe = appData.vpeFilters.size === 0 || appData.vpeFilters.has(vpeName);
                if (!passVpe) return false;

                const fIdx = findIdx(['frente'], 12);
                const rowFrente = row[fIdx] ? String(row[fIdx]).trim() : '';
                const passFrente = appData.frenteFilters.size === 0 || appData.frenteFilters.has(rowFrente);
                if (!passFrente) return false;

                const respName = row[10] ? String(row[10]).trim() : '';
                const passResp = appData.respFilters.size === 0 || appData.respFilters.has(respName);
                if (!passResp) return false;

                const rowCat = row[catIdx] ? String(row[catIdx]).trim().toLowerCase() : '';
                const passCat = appData.catFilters.size === 0 || Array.from(appData.catFilters).some(f => {
                    const l = f.toLowerCase();
                    return rowCat.includes(l) || l.includes(rowCat);
                });
                if (!passCat) return false;

                return true;
            });

            filteredBase.forEach(row => {
                const vpe = row[vpeIdx] ? String(row[vpeIdx]).trim() : 'Sin VPE';
                if (!vpeMap[vpe]) {
                    vpeMap[vpe] = {
                        meta: 0,
                        pot: 0,
                        manos: 0,
                        personal: 0,
                        fte: 0,
                        q1: 0, q2: 0, q3: 0, q4: 0,
                        q1M: 0, q2M: 0, q3M: 0, q4M: 0
                    };
                }

                const meta = parseFloat(String(row[metaIdx]).replace(/[^0-9.-]+/g, "")) || 0;
                // If meta is very small (e.g. 5), treat as Millions
                const metaUnit = meta < 100000 ? meta * 1e6 : meta;

                vpeMap[vpe].meta += metaUnit;
                const p = parseFloat(String(row[potIdx]).replace(/[^0-9.-]+/g, "")) || 0;
                const m = parseFloat(String(row[matIdx]).replace(/[^0-9.-]+/g, "")) || 0;
                const ft = parseFloat(row[fteIdx]) || 0;
                const cat = (row[catIdx] || "").toString().toUpperCase();

                vpeMap[vpe].pot += p;
                vpeMap[vpe].mat += m;
                vpeMap[vpe].fte += ft;

                if (cat.includes("MANOS")) vpeMap[vpe].manos += p;
                else if (cat.includes("PERSONAL")) vpeMap[vpe].personal += p;

                vpeMap[vpe].q1 += parseFloat(row[51]) || 0;
                vpeMap[vpe].q2 += parseFloat(row[52]) || 0;
                vpeMap[vpe].q3 += parseFloat(row[53]) || 0;
                vpeMap[vpe].q4 += parseFloat(row[54]) || 0;
            });

            // Running totals for footer and KPI cards
            let grandMeta = 0, grandPot = 0, grandManos = 0, grandPersonal = 0, grandFte = 0;
            let grandQ1 = 0, grandQ2 = 0, grandQ3 = 0, grandQ4 = 0;
            let totalMat = 0, totalPyg = 0;
            let grandQ1M = 0, grandQ2M = 0, grandQ3M = 0, grandQ4M = 0;

            filteredBase.forEach(row => {
                totalMat += parseFloat(String(row[matIdx]).replace(/[^0-9.-]+/g, "")) || 0;
                totalPyg += parseFloat(row[pygIdx]) || 0;
                grandQ1M += parseFloat(row[85]) || 0; grandQ2M += parseFloat(row[86]) || 0;
                grandQ3M += parseFloat(row[87]) || 0; grandQ4M += parseFloat(row[88]) || 0;
            });

            document.getElementById('pot-total-exec').innerText = `$${fmt(filteredBase.reduce((acc, r) => acc + (parseFloat(String(r[potIdx]).replace(/[^0-9.-]+/g, "")) || 0), 0))}M`;
            document.getElementById('mat-total-exec').innerText = `$${fmt(totalMat)}M`;
            document.getElementById('pyg-total').innerText = `$${fmt(totalPyg)}M`;

            Object.keys(vpeMap).sort((a, b) => vpeMap[b].meta - vpeMap[a].meta).forEach(vpe => {
                const i = vpeMap[vpe];
                // Only show rows that have some data or a meta
                if (i.meta === 0 && i.pot === 0 && i.mat === 0) return;

                grandMeta += i.meta; grandPot += i.pot; grandManos += i.manos;
                grandPersonal += i.personal; grandFte += i.fte;
                grandQ1 += i.q1; grandQ2 += i.q2; grandQ3 += i.q3; grandQ4 += i.q4;

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50/50 dark:hover:bg-slate-800/30 transition-all border-b border-slate-100 dark:border-slate-800 group";

                const fmtQ = (val, totalMeta) => {
                    const p = totalMeta > 0 ? (val / totalMeta * 100).toFixed(1) : '0.0';
                    return `<div class="flex items-center justify-center gap-2"><span class="font-black text-slate-700 dark:text-slate-300">$${fmt(val)}</span><span class="text-[9px] text-emerald-600 dark:text-emerald-400 font-black px-1.5 py-0.5 bg-emerald-50 dark:bg-emerald-900/20 rounded-md">${p}%</span></div>`;
                };

                tr.innerHTML = `
                    <td class="px-8 py-5 font-black text-slate-900 dark:text-slate-100 border-r border-slate-100 dark:border-slate-800/50">${vpe}</td>
                    <td class="px-6 py-5 font-bold text-slate-500 dark:text-slate-400 text-center border-r border-slate-100 dark:border-slate-800/50 bg-slate-50/20 dark:bg-slate-900/20 text-xs">$${fmt(i.meta)}M</td>
                    <!-- Oportunidad deslose (M.Ext -> G.Person -> Total) -->
                    <td class="px-4 py-5 font-bold text-slate-600 dark:text-slate-400 text-center border-r border-slate-100 dark:border-slate-800/50">$${fmt(i.manos)}</td>
                    <td class="px-4 py-5 font-bold text-slate-600 dark:text-slate-400 text-center border-r border-slate-100 dark:border-slate-800/50">$${fmt(i.personal)}</td>
                    <td class="px-4 py-5 font-black text-indigo-600 dark:text-indigo-400 text-center border-r border-slate-100 dark:border-slate-800/50 bg-indigo-50/10 dark:bg-indigo-900/10">$${fmt(i.pot)}</td>
                    
                    <td class="px-6 py-5 font-black text-slate-800 dark:text-slate-200 text-center text-[13px] border-r border-slate-100 dark:border-slate-800/50">${i.fte.toFixed(0)}</td>
                    
                    <td class="px-6 py-5 text-center border-r border-slate-100 dark:border-slate-800/50 group-hover:bg-emerald-50/10">${fmtQ(i.q1, i.meta)}</td>
                    <td class="px-6 py-5 text-center border-r border-slate-100 dark:border-slate-800/50 group-hover:bg-emerald-50/10">${fmtQ(i.q2, i.meta)}</td>
                    <td class="px-6 py-5 text-center border-r border-slate-100 dark:border-slate-800/50 group-hover:bg-emerald-50/10">${fmtQ(i.q3, i.meta)}</td>
                    <td class="px-6 py-5 text-center group-hover:bg-emerald-50/10">${fmtQ(i.q4, i.meta)}</td>
                `;
                tbody.appendChild(tr);
            });

            // Add totals row (FIXED for Light Mode contrast - FORCING WHITE TEXT VIA STYLE)
            const tf = document.createElement('tr');
            tf.className = "bg-slate-800 dark:bg-slate-900 text-white font-black text-xs uppercase tracking-widest shadow-2xl relative z-10 sticky bottom-0 border-t-2 border-slate-700";

            const whiteStyle = 'style="color: white !important;"';
            tf.innerHTML = `
                <td class="px-8 py-7" ${whiteStyle}>TOTAL GENERAL</td>
                <td class="px-6 py-7 text-center border-r border-slate-700/50 bg-slate-700/20" ${whiteStyle}>$${fmt(grandMeta / 1e6)}M</td>
                <td class="px-4 py-7 text-center border-r border-slate-700/50 bg-slate-700/20" ${whiteStyle}>$${fmt(grandManos)}</td>
                <td class="px-4 py-7 text-center border-r border-slate-700/50 bg-slate-700/20" ${whiteStyle}>$${fmt(grandPersonal)}</td>
                <td class="px-4 py-7 text-center border-r border-slate-700/50 bg-indigo-600/90 shadow-inner" ${whiteStyle}>$${fmt(grandPot)}</td>
                <td class="px-6 py-7 text-center border-r border-slate-700/50 bg-slate-700/20 text-[15px]" ${whiteStyle}>${grandFte.toFixed(0)}</td>
                <td class="px-6 py-7 text-center border-r border-slate-700/50 bg-emerald-700/60" ${whiteStyle}>$${fmt(grandQ1)}</td>
                <td class="px-6 py-7 text-center border-r border-slate-700/50 bg-emerald-700/60" ${whiteStyle}>$${fmt(grandQ2)}</td>
                <td class="px-6 py-7 text-center border-r border-slate-700/50 bg-emerald-700/60" ${whiteStyle}>$${fmt(grandQ3)}</td>
                <td class="px-6 py-7 text-center bg-emerald-700/60" ${whiteStyle}>$${fmt(grandQ4)}</td>
            `;
            tbody.appendChild(tf);

            // Update charts with aggregated data
            renderVPECharts(Object.keys(vpeMap).filter(v => vpeMap[v].pot > 0), Object.keys(vpeMap).filter(v => vpeMap[v].pot > 0).map(v => vpeMap[v].pot / 1e6), [grandQ1, grandQ2, grandQ3, grandQ4], [grandQ1M, grandQ2M, grandQ3M, grandQ4M]);

            // Sync with other filters
            const buildVPEChips = (containerId, sourceSet, activeSet) => {
                const box = document.getElementById(containerId);
                if (!box) return;
                box.innerHTML = '';
                Array.from(sourceSet).sort().forEach(v => {
                    const b = document.createElement('button');
                    const isActive = activeSet.has(v);
                    b.className = `px-4 py-1.5 text-[10px] font-black rounded-lg border transition-all uppercase tracking-tighter ${isActive ? 'bg-indigo-600 text-white border-indigo-600 shadow-md transform scale-105' : 'border-slate-200 text-slate-400 hover:border-indigo-400'}`;
                    b.innerText = v;
                    b.onclick = () => { if (activeSet.has(v)) activeSet.delete(v); else activeSet.add(v); buildVPEView(); buildInitiativesView(); };
                    box.appendChild(b);
                });
            };

            const allVpes = new Set();
            const frentes = new Set();
            const fIdx = findIdx(['frente'], 12);
            appData.baseData.forEach(r => {
                if (r[vpeIdx]) allVpes.add(String(r[vpeIdx]).trim());
                if (r[fIdx]) frentes.add(String(r[fIdx]).trim());
            });

            const allResps = new Set();
            appData.baseData.forEach(r => { if (r[10]) allResps.add(String(r[10]).trim()); });
            buildVPEChips('vpe-responsable-filters', allResps, appData.respFilters);

            buildVPEChips('vpe-frente-filters', frentes, appData.frenteFilters);
            buildVPEChips('vpe-vpe-filters', allVpes, appData.vpeFilters);

            renderVPEGantt(filteredBase);
        }

        function triggerExportToSheets() {
            showToast('Preparando exportaciÃ³n...');

            // Get currently filtered data (Respecting all current filters)
            const vpeIdx = findIdx(['vpe'], 3);
            const deptIdx = findIdx(['departamento', 'equipo'], 4);
            const fIdx = findIdx(['frente'], 12);

            const filtered = appData.baseData.filter(row => {
                if (!row) return false;
                if (appData.user.perfil == 2 && appData.execViewToggle === 'team') {
                    const rowDept = row[deptIdx] ? String(row[deptIdx]).trim().toLowerCase() : '';
                    const userDept = appData.user.departamento ? String(appData.user.departamento).trim().toLowerCase() : '';
                    const isOwnTeam = (rowDept === userDept) || (appData.user.deptUsers || []).some(u =>
                        [row[14], row[15], row[16]].some(r => r && String(r).trim() === String(u).trim())
                    );
                    if (!isOwnTeam) return false;
                }
                const vpeName = row[vpeIdx] ? String(row[vpeIdx]).trim() : '';
                const respName = row[10] ? String(row[10]).trim() : '';
                const rowFrente = row[fIdx] ? String(row[fIdx]).trim() : '';
                const rowCat = row[findIdx(['categoria', 'fuente', 'manos'], 6)] ? String(row[findIdx(['categoria', 'fuente', 'manos'], 6)]).trim().toLowerCase() : '';

                const passVpe = appData.vpeFilters.size === 0 || appData.vpeFilters.has(vpeName);
                const passResp = appData.respFilters.size === 0 || appData.respFilters.has(respName);
                const passFrente = appData.frenteFilters.size === 0 || appData.frenteFilters.has(rowFrente);
                const passCat = appData.catFilters.size === 0 || Array.from(appData.catFilters).some(f => {
                    const l = f.toLowerCase();
                    return rowCat.includes(l) || l.includes(rowCat);
                });

                return passVpe && passResp && passFrente && passCat;
            });

            google.script.run
                .withSuccessHandler(res => {
                    if (res.success) {
                        showToast('ExportaciÃ³n completada');
                        window.open(res.url, '_blank');
                    } else {
                        showToast('Error: ' + res.error);
                    }
                })
                .withFailureHandler(err => {
                    showToast('Error de conexiÃ³n');
                    console.error(err);
                })
                .exportFilteredDataToSheets(filtered, appData.headers);
        }
        function renderVPECharts(labels, pots, qExpected, qMaterialized) {
            const ctxQ = document.getElementById('vpe-quarter-chart').getContext('2d');
            const ctxP = document.getElementById('vpe-pie-chart').getContext('2d');
            if (vpeChartInstance) vpeChartInstance.destroy();
            if (vpePieChartInstance) vpePieChartInstance.destroy();
            const isDark = document.body.classList.contains('dark');
            const textColor = isDark ? '#f1f5f9' : '#1e293b';
            const gridColor = isDark ? '#334155' : '#f1f5f9';
            vpeChartInstance = new Chart(ctxQ, {
                type: 'bar',
                data: {
                    labels: ['Q1', 'Q2', 'Q3', 'Q4', 'Total'],
                    datasets: [
                        { label: 'Esperado', data: [...qExpected, qExpected.reduce((a, b) => a + b, 0)].map(v => v / 1000000), backgroundColor: '#818cf8', borderRadius: 6 },
                        { label: 'Materializado', data: [...qMaterialized, qMaterialized.reduce((a, b) => a + b, 0)].map(v => v / 1000000), backgroundColor: '#10b981', borderRadius: 6 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'bottom', labels: { color: textColor, font: { weight: 'bold' } } } },
                    scales: {
                        y: { grid: { color: gridColor }, ticks: { color: textColor, font: { weight: 'bold' } } },
                        x: { grid: { display: false }, ticks: { color: textColor, font: { weight: 'bold' } } }
                    }
                }
            });
            vpePieChartInstance = new Chart(ctxP, {
                type: 'doughnut',
                data: { labels, datasets: [{ data: pots, backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6', '#06b6d4'], borderWidth: 0, hoverOffset: 30, spacing: 8 }] },
                options: { cutout: '75%', responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: textColor, padding: 25, font: { weight: 'bold', size: 11 } } }, tooltip: { padding: 16, displayColors: true, backgroundColor: isDark ? '#1e293b' : '#ffffff', bodyColor: isDark ? '#f1f5f9' : '#1e293b' } } }
            });
        }
        function buildInitiativesView() {
            const resps = new Set(), vpes = new Set();
            appData.baseData.forEach(row => {
                if (!row) return;
                if (row[10]) resps.add(String(row[10]).trim());
                if (row[3]) vpes.add(String(row[3]).trim());
            });
            const buildChips = (containerId, sourceSet, activeSet) => {
                const box = document.getElementById(containerId);
                box.innerHTML = '';
                Array.from(sourceSet).sort().forEach(v => {
                    const b = document.createElement('button');
                    const isActive = activeSet.has(v);
                    b.className = `px-4 py-1.5 text-[10px] font-black rounded-lg border transition-all uppercase tracking-tighter ${isActive ? 'bg-indigo-600 text-white border-indigo-600 shadow-md transform scale-105' : 'border-slate-200 text-slate-400 hover:border-indigo-400'}`;
                    b.innerText = v;
                    b.onclick = () => { if (activeSet.has(v)) activeSet.delete(v); else activeSet.add(v); buildInitiativesView(); };
                    box.appendChild(b);
                });
            };
            buildChips('responsable-filters', resps, appData.respFilters);
            buildChips('vpe-filters', vpes, appData.vpeFilters);

            const frentes = new Set();
            const fIdx = findIdx(['frente'], 12);
            appData.baseData.forEach(row => { if (row && row[fIdx]) frentes.add(String(row[fIdx]).trim()); });
            buildChips('frente-filters', frentes, appData.frenteFilters);

            const vpeP = document.getElementById('vpe-filter-parent');
            if (vpeP) vpeP.className = appData.user.perfil == 1 ? "block" : "hidden";
            const tbody = document.getElementById('initiatives-table-body');
            tbody.innerHTML = '';
            const potIdx = findIdx(['potencial ($)'], 18);
            const matIdx = findIdx(['materializado ($)'], 80);
            const potFteIdx = findIdx(['potencial (fte)'], 17);
            const matFteIdx = findIdx(['materializado (fte)'], 79);
            const catIdx = findIdx(['categoria', 'fuente', 'manos'], 6);
            const vpeIdx = findIdx(['vpe'], 3);
            const deptIdx = findIdx(['departamento', 'equipo'], 4);
            let fPot = 0, fMat = 0, fPotFte = 0, fMatFte = 0;
            const filtered = appData.baseData.filter(row => {
                if (!row) return false;
                if (appData.user.perfil == 2 && appData.execViewToggle === 'team') {
                    const rowDept = row[deptIdx] ? String(row[deptIdx]).trim().toLowerCase() : '';
                    const userDept = appData.user.departamento ? String(appData.user.departamento).trim().toLowerCase() : '';
                    const isOwnTeam = (rowDept === userDept) || (appData.user.deptUsers || []).some(u =>
                        [row[14], row[15], row[16]].some(r => r && String(r).trim() === String(u).trim())
                    );
                    if (!isOwnTeam) return false;
                }
                const vpeName = row[vpeIdx] ? String(row[vpeIdx]).trim() : '';
                const respName = row[10] ? String(row[10]).trim() : '';
                const rowCat = row[catIdx] ? String(row[catIdx]).trim().toLowerCase() : '';
                const passVpe = appData.vpeFilters.size === 0 || appData.vpeFilters.has(vpeName);
                const passResp = appData.respFilters.size === 0 || appData.respFilters.has(respName);
                const passCat = appData.catFilters.size === 0 || Array.from(appData.catFilters).some(f => {
                    const l = f.toLowerCase();
                    return rowCat.includes(l) || l.includes(rowCat);
                });
                const rowFrente = row[fIdx] ? String(row[fIdx]).trim() : '';
                const passFrente = appData.frenteFilters.size === 0 || appData.frenteFilters.has(rowFrente);
                return passVpe && passResp && passCat && passFrente;
            });
            filtered.forEach(r => {
                const p = parseFloat(String(r[potIdx]).replace(/[^0-9.-]+/g, "")) || 0;
                const m = parseFloat(String(r[matIdx]).replace(/[^0-9.-]+/g, "")) || 0;
                fPot += p; fMat += m;
                fPotFte += parseFloat(r[potFteIdx]) || 0; fMatFte += parseFloat(r[matFteIdx]) || 0;
            });
            document.getElementById('count-init').innerText = filtered.length;
            document.getElementById('pot-init').innerText = `$${fmt(fPot)}M`;
            document.getElementById('mat-init').innerText = `$${fmt(fMat)}M`;
            document.getElementById('pot-fte-init').innerText = fPotFte.toFixed(1);
            document.getElementById('mat-fte-init').innerText = fMatFte.toFixed(1);
            const catBoxInit = document.getElementById('init-category-filters');
            if (catBoxInit) {
                catBoxInit.innerHTML = '';
                ['Manos Extendidas', 'Gasto de Personal'].forEach(v => {
                    const isActive = appData.catFilters.has(v);
                    const b = document.createElement('button');
                    b.className = `px-4 py-1.5 text-[10px] font-black rounded-lg border transition-all uppercase tracking-tighter ${isActive ? 'bg-indigo-600 text-white border-indigo-600 shadow-md transform scale-105' : 'border-slate-200 text-slate-400 hover:border-indigo-400'}`;
                    b.innerText = v;
                    b.onclick = () => { if (appData.catFilters.has(v)) appData.catFilters.delete(v); else appData.catFilters.add(v); buildInitiativesView(); if (document.getElementById('view-vpe').classList.contains('hidden') === false) buildVPEView(); };
                    catBoxInit.appendChild(b);
                });
            }
            filtered.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50/80 dark:hover:bg-slate-800/40 transition-all border-b border-slate-100 dark:border-slate-800";
                const cod = row[0], name = row[1], type = row[6], vpe = row[vpeIdx], resp = row[10];
                const pUSD = parseFloat(String(row[potIdx]).replace(/[^0-9.-]+/g, "")) || 0;
                const mUSD = parseFloat(String(row[matIdx]).replace(/[^0-9.-]+/g, "")) || 0;
                const pFTE = parseFloat(row[potFteIdx]) || 0;
                const mFTE = parseFloat(row[matFteIdx]) || 0;
                const avance = pUSD > 0 ? (mUSD / pUSD * 100).toFixed(1) : "0.0";
                tr.innerHTML = `
                    <td class="px-6 py-5 font-black text-slate-900 dark:text-white truncate max-w-[300px] whitespace-normal leading-relaxed" title="${name}">${name}</td>
                    <td class="px-4 py-5 font-mono text-[10px] text-slate-500 dark:text-slate-400 font-bold">${cod || 'N/A'}</td>
                    <td class="px-4 py-5 text-[10px] font-black text-indigo-500 dark:text-indigo-400 uppercase tracking-tighter">${type || 'N/A'}</td>
                    <td class="px-4 py-5 text-[10px] font-bold text-slate-500 dark:text-slate-400 capitalize">${String(vpe || 'N/A').toLowerCase()}</td>
                    <td class="px-4 py-5 text-[10px] font-bold text-slate-500 dark:text-slate-400 capitalize">${String(resp || 'N/A').toLowerCase()}</td>
                    <td class="px-4 py-5 font-black text-indigo-600 dark:text-indigo-400 text-right whitespace-nowrap">$${fmt(pUSD)}M</td>
                    <td class="px-4 py-5 font-black text-indigo-400 dark:text-indigo-300 text-right whitespace-nowrap">${pFTE.toFixed(1)}</td>
                    <td class="px-4 py-5 font-black text-emerald-600 dark:text-emerald-400 text-right whitespace-nowrap">$${fmt(mUSD)}M</td>
                    <td class="px-4 py-5 font-black text-emerald-400 dark:text-emerald-300 text-right whitespace-nowrap">${mFTE.toFixed(1)}</td>
                    <td class="px-4 py-5 text-center"><div class="flex flex-col items-center"><span class="text-[10px] font-black text-slate-600 dark:text-slate-300">${avance}%</span><div class="w-12 h-1 bg-slate-100 dark:bg-slate-800 rounded-full mt-1 overflow-hidden"><div class="h-full bg-indigo-500" style="width: ${Math.min(parseFloat(avance), 100)}%"></div></div></div></td>
                    <td class="px-4 py-5 text-center"><button onclick="openHitosModal('${cod || ""}', '${String(name || "").replace(/'/g, "")}')" class="p-2 text-rose-400 hover:text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/40 rounded-full transition-all" title="Ver Hitos">ðŸš©</button></td>
                    <td class="px-4 py-5 text-center"><button onclick="openModal('${cod || ""}', '${String(name || "").replace(/'/g, "")}')" class="p-2 text-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/40 rounded-full transition-all">âœŽ</button></td>
                `;
                tbody.appendChild(tr);
            });
            renderGantt(filtered);
            renderInitCharts(filtered);
        }
        function renderGantt(data) {
            const container = document.getElementById('gantt-container'); container.innerHTML = '';
            const dropdown = document.getElementById('gantt-init-filter');

            // Populate dropdown with CURRENT data (global filters already applied)
            const currentVal = appData.ganttFilter;
            dropdown.innerHTML = '<option value="all">VER TODAS LAS INICIATIVAS</option>';
            const uniqueInits = [...new Set(data.map(r => String(r[1]).trim()))].sort();
            uniqueInits.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name; opt.innerText = name;
                dropdown.appendChild(opt);
            });
            dropdown.value = currentVal;
            if (dropdown.selectedIndex === -1) { dropdown.value = 'all'; appData.ganttFilter = 'all'; }

            // Secondary Filter for Gantt ONLY
            const displayData = appData.ganttFilter === 'all' ? data : data.filter(r => String(r[1]).trim() === appData.ganttFilter);

            // Sort by Category: Gasto de Personal first, then Manos Extendidas
            const catOrder = { "GASTO DE PERSONAL": 1, "MANOS EXTENDIDAS": 2 };
            displayData.sort((a, b) => {
                const cA = (a[6] || "").trim().toUpperCase();
                const cB = (b[6] || "").trim().toUpperCase();
                return (catOrder[cA] || 99) - (catOrder[cB] || 99);
            });

            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const gHeader = document.createElement('div'); gHeader.className = "flex flex-col gap-1 px-6 mb-4";

            let qLabels = '<div class="flex-1 grid grid-cols-4 gap-2 text-[12px] font-black text-slate-400 uppercase tracking-widest text-center px-2">';
            ['Q1', 'Q2', 'Q3', 'Q4'].forEach(q => { qLabels += `<div class="border-b-2 border-slate-100 dark:border-slate-800 pb-1">${q}</div>`; });
            qLabels += '</div>';

            let monthLabels = '';
            months.forEach((m, idx) => {
                const isDivider = [2, 5, 8].includes(idx);
                monthLabels += `<div class="flex-1 text-center text-[12px] uppercase tracking-widest text-slate-900 dark:text-slate-100 font-black ${isDivider ? 'border-r-2 border-slate-300 dark:border-slate-700' : ''}">${m}</div>`;
            });

            gHeader.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="w-[450px] shrink-0"></div>
                    ${qLabels}
                </div>
                <div class="flex items-center gap-4">
                    <div class="w-[450px] shrink-0"></div>
                    <div class="flex-1 grid grid-cols-12 gap-2 pr-2">${monthLabels}</div>
                </div>
            `;
            container.appendChild(gHeader);

            displayData.forEach(r => {
                const row = document.createElement('div'); row.className = "gantt-row group hover:bg-slate-50/50 transition-all px-6 rounded-3xl min-h-[60px] flex items-center";
                const cat = (r[6] || '').trim();
                const isManos = cat.toUpperCase().includes("MANOS");
                const catColorClass = isManos
                    ? "bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-400"
                    : "bg-indigo-100 dark:bg-indigo-900/40 text-indigo-700 dark:text-indigo-400";

                const label = document.createElement('div');
                label.className = "w-[450px] shrink-0 text-sm font-black text-slate-900 dark:text-white pr-4 leading-tight";
                label.innerHTML = `${r[1]} <span class="${catColorClass} px-2 py-0.5 rounded-full text-[10px] font-black ml-2 whitespace-nowrap uppercase">${cat}</span>`;
                label.title = r[1];
                const lineContainer = document.createElement('div'); lineContainer.className = "gantt-lines-container";
                const cod = String(r[0]).trim();
                const initiativeMilestones = appData.milestones.filter(m => m[1] && String(m[1]).trim() === cod);
                for (let i = 0; i < 12; i++) {
                    const isDivider = [2, 5, 8].includes(i);
                    const seg = document.createElement('div'); seg.className = `line-segment ${isDivider ? 'border-r-2 border-slate-200 dark:border-slate-800/50 pr-1' : ''}`;
                    const exp = parseFloat(r[33 + i]) || 0, mat = parseFloat(r[67 + i]) || 0;
                    const w = exp > 0 ? (mat / exp) * 100 : (mat > 0 ? 100 : 0);
                    const dispE = exp > 0 ? (exp / 1e6).toFixed(1) + 'M' : '';
                    const dispM = mat > 0 ? (mat / 1e6).toFixed(1) + 'M' : '';
                    seg.innerHTML = `${dispE ? `<div class="gantt-value-top text-[11px] font-black">${dispE}</div>` : ''}<div class="gantt-line-expected ${exp === 0 ? 'hidden' : ''}"></div><div class="gantt-line-materialized ${mat === 0 ? 'shaded' : ''}" style="width:${Math.min(w, 100)}%"></div>${dispM ? `<div class="gantt-value-bottom text-[11px] font-black">${dispM}</div>` : ''}`;
                    initiativeMilestones.forEach(m => {
                        const mDate = m[3] ? new Date(m[3]) : null;
                        if (mDate && !isNaN(mDate.getTime()) && mDate.getMonth() === i) {
                            const flag = document.createElement('div'); flag.className = "gantt-flag animate-bounce-subtle"; flag.innerHTML = "ðŸš©"; flag.onclick = (e) => { e.stopPropagation(); openHitosModal(cod, r[1]); };
                            seg.appendChild(flag);
                        }
                    });
                    lineContainer.appendChild(seg);
                }
                row.appendChild(label); row.appendChild(lineContainer); container.appendChild(row);
            });
        }
        function renderVPEGantt(data) {
            const container = document.getElementById('vpe-gantt-container');
            container.innerHTML = '';
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

            // Group by VPE
            const vpeIdx = findIdx(['vpe'], 3);
            const potIdx = findIdx(['total eficiencia identificada', 'potencial ($)'], 18);
            const matIdx = findIdx(['materializado ($)'], 80);

            const groups = {};
            data.forEach(r => {
                const vpe = r[vpeIdx] ? String(r[vpeIdx]).trim() : 'Sin VPE';
                if (!groups[vpe]) groups[vpe] = { name: vpe, inits: [], totalExp: 0, totalMat: 0 };
                const p = parseFloat(String(r[potIdx]).replace(/[^0-9.-]+/g, "")) || 0;
                const m = parseFloat(String(r[matIdx]).replace(/[^0-9.-]+/g, "")) || 0;
                groups[vpe].totalExp += p; groups[vpe].totalMat += m;
                groups[vpe].inits.push(r);
            });

            Object.values(groups).sort((a, b) => b.totalExp - a.totalExp).forEach(group => {
                // Sort initiatives within the VPE: Gasto de Personal first
                const catOrder = { "GASTO DE PERSONAL": 1, "MANOS EXTENDIDAS": 2 };
                group.inits.sort((a, b) => {
                    const cA = (a[6] || "").trim().toUpperCase();
                    const cB = (b[6] || "").trim().toUpperCase();
                    return (catOrder[cA] || 99) - (catOrder[cB] || 99);
                });

                const groupDiv = document.createElement('div');
                groupDiv.className = "vpe-gantt-group";

                const header = document.createElement('div');
                header.className = "vpe-gantt-vpe-header";
                header.innerHTML = `
                    <span>${group.name}</span>
                    <div class="flex items-center gap-8">
                        <div class="flex gap-4 opacity-50 text-[9px]">
                            <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-indigo-400"></div> POT</div>
                            <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-emerald-400"></div> MAT</div>
                            <div class="flex items-center gap-1.5"><span>ðŸš©</span> HITOS</div>
                        </div>
                        <div class="flex gap-4 border-l border-slate-200 dark:border-slate-700 pl-8">
                            <span>POT: $${fmt(group.totalExp)}M</span>
                            <span>MAT: $${fmt(group.totalMat)}M</span>
                        </div>
                    </div>
                `;
                groupDiv.appendChild(header);

                const cleanVpeName = group.name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
                const isTec = cleanVpeName.includes('TECNOLOGIA');

                const gHeader = document.createElement('div');
                gHeader.className = "gantt-row-container mb-4 mt-8 opacity-70";

                let qHtml = '';
                ['Q1', 'Q2', 'Q3', 'Q4'].forEach(q => {
                    qHtml += `<div class="text-center font-black pb-1 border-b border-slate-200 dark:border-slate-800 text-[11px] uppercase tracking-widest text-slate-400" style="grid-column: span 3">${q}</div>`;
                });

                let mHtml = '';
                months.forEach((m, idx) => {
                    const isDivider = [2, 5, 8].includes(idx);
                    mHtml += `<div class="text-center text-[12px] uppercase tracking-widest text-slate-900 dark:text-slate-100 font-black ${isDivider ? 'border-r-2 border-slate-300 dark:border-slate-700' : ''}">${m}</div>`;
                });

                gHeader.innerHTML = `
                    <div class="flex flex-col flex-1">
                        <div class="flex items-center">
                            <div class="gantt-label-box text-[10px] font-black uppercase text-slate-400">Cronograma Mensal / Trimestral</div>
                            <div class="gantt-grid-system">${qHtml}</div>
                        </div>
                        <div class="flex items-center mt-2">
                            <div class="gantt-label-box"></div>
                            <div class="gantt-grid-system">${mHtml}</div>
                        </div>
                    </div>
                `;
                groupDiv.appendChild(gHeader);

                const monthlyTotalsGroup = Array.from({ length: 12 }, () => ({ exp: 0, mat: 0 }));
                const vpIdx = 4; // Col E

                // Optimization: Pre-sort or partition if VPE is TecnologÃ­a
                if (cleanVpeName.includes('TECNOLOGIA')) {
                    const subGroupsMap = {};
                    group.inits.forEach(r => {
                        const vpLine = r[vpIdx] ? String(r[vpIdx]).trim() : 'Otros';
                        if (!subGroupsMap[vpLine]) subGroupsMap[vpLine] = { inits: [], pot: 0, mat: 0, monthly: Array.from({ length: 12 }, () => ({ exp: 0, mat: 0 })) };
                        const p = parseFloat(String(r[potIdx]).replace(/[^0-9.-]+/g, "")) || 0;
                        const m = parseFloat(String(r[matIdx]).replace(/[^0-9.-]+/g, "")) || 0;
                        subGroupsMap[vpLine].pot += p; subGroupsMap[vpLine].mat += m;
                        subGroupsMap[vpLine].inits.push(r);
                    });

                    Object.keys(subGroupsMap).sort().forEach(vp => {
                        const sg = subGroupsMap[vp];

                        // Sub-header
                        const sh = document.createElement('div');
                        sh.className = "px-6 py-2 mt-8 mb-2 bg-indigo-50/30 dark:bg-indigo-900/10 rounded-xl flex justify-between items-center border-l-4 border-indigo-600 ml-4 shadow-sm";
                        sh.innerHTML = `
                            <span class="text-[11px] font-black text-indigo-600 dark:text-indigo-400 uppercase tracking-widest">${vp}</span>
                            <div class="flex gap-4 text-[9px] font-black uppercase tracking-tight">
                                <span class="bg-indigo-600 text-white px-3 py-0.5 rounded-full">POT: $${fmt(sg.pot)}M</span>
                                <span class="bg-emerald-600 text-white px-3 py-0.5 rounded-full">MAT: $${fmt(sg.mat)}M</span>
                            </div>
                        `;
                        groupDiv.appendChild(sh);

                        // Contextual Header for each sub-group (Months + Qs)
                        const subHeaderLabels = document.createElement('div');
                        subHeaderLabels.className = "gantt-row-container mb-2 opacity-60";

                        let sgQHtml = '';
                        ['Q1', 'Q2', 'Q3', 'Q4'].forEach(q => {
                            sgQHtml += `<div class="text-center font-black pb-1 border-b border-slate-200 dark:border-slate-800 text-[9px] uppercase tracking-widest text-slate-400" style="grid-column: span 3">${q}</div>`;
                        });

                        let sgMHtml = '';
                        months.forEach((m, idx) => {
                            const isDivider = [2, 5, 8].includes(idx);
                            sgMHtml += `<div class="text-center text-[10px] uppercase tracking-widest text-slate-500 dark:text-slate-400 font-bold ${isDivider ? 'border-r-2 border-slate-200 dark:border-slate-800' : ''}">${m}</div>`;
                        });

                        subHeaderLabels.innerHTML = `
                            <div class="flex flex-col flex-1">
                                <div class="flex items-center">
                                    <div class="gantt-label-box"></div>
                                    <div class="gantt-grid-system">${sgQHtml}</div>
                                </div>
                                <div class="flex items-center mt-1">
                                    <div class="gantt-label-box"></div>
                                    <div class="gantt-grid-system">${sgMHtml}</div>
                                </div>
                            </div>
                        `;
                        groupDiv.appendChild(subHeaderLabels);

                        // Initiatives in sub-group
                        sg.inits.forEach(r => {
                            const row = renderGanttRow(r, potIdx, matIdx);
                            // Accumulate for sub-group AND global group
                            for (let i = 0; i < 12; i++) {
                                const exp = parseFloat(r[33 + i]) || 0, mat = parseFloat(r[67 + i]) || 0;
                                sg.monthly[i].exp += exp; sg.monthly[i].mat += mat;
                                monthlyTotalsGroup[i].exp += exp; monthlyTotalsGroup[i].mat += mat;
                            }
                            groupDiv.appendChild(row);
                        });

                        // Sub-total Monthly Row for this VP
                        const subTotalRow = renderSummaryRow(`SUB-TOTAL ${vp}`, sg.monthly, "bg-indigo-50/10 dark:bg-indigo-900/5 mt-1 mb-4 border-dashed border-indigo-200 dark:border-indigo-900/30");
                        groupDiv.appendChild(subTotalRow);
                    });
                } else {
                    group.inits.forEach(r => {
                        const row = renderGanttRow(r, potIdx, matIdx);
                        for (let i = 0; i < 12; i++) {
                            const exp = parseFloat(r[33 + i]) || 0, mat = parseFloat(r[67 + i]) || 0;
                            monthlyTotalsGroup[i].exp += exp; monthlyTotalsGroup[i].mat += mat;
                        }
                        groupDiv.appendChild(row);
                    });
                }

                // Global VPE Total Summary Row
                const finalTotalRow = renderSummaryRow(`RESUMEN TOTAL ${group.name}`, monthlyTotalsGroup, "bg-slate-100 dark:bg-slate-800/40 border-t-2 border-slate-200 dark:border-slate-700 mt-6 shadow-md rounded-b-3xl");
                groupDiv.appendChild(finalTotalRow);
                container.appendChild(groupDiv);
            });
        }

        function renderGanttRow(r, potIdx, matIdx) {
            const row = document.createElement('div');
            row.className = "gantt-row-container group hover:bg-slate-50/50 transition-all rounded-3xl min-h-[60px]";
            const cat = (r[6] || '').trim();
            const isManos = cat.toUpperCase().includes("MANOS");
            const catColorClass = isManos
                ? "bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-400"
                : "bg-indigo-100 dark:bg-indigo-900/40 text-indigo-700 dark:text-indigo-400";

            const pUSD = parseFloat(String(r[potIdx]).replace(/[^0-9.-]+/g, "")) || 0;
            const mUSD = parseFloat(String(r[matIdx]).replace(/[^0-9.-]+/g, "")) || 0;

            const label = document.createElement('div');
            label.className = "gantt-label-box font-black text-indigo-600 dark:text-indigo-400 cursor-pointer hover:underline decoration-2 underline-offset-4 leading-tight py-2";
            label.innerHTML = `
                <div class="flex flex-col w-full">
                    <div class="flex items-baseline gap-2">
                        <span class="whitespace-normal break-words">${r[1]}</span>
                        <span class="px-1.5 py-0.5 rounded text-[8px] font-black uppercase whitespace-nowrap ${catColorClass} shrink-0">${cat}</span>
                    </div>
                    <div class="flex gap-4 opacity-50 text-[11px] mt-1 font-bold">
                        <span>POT: $${fmt(r[potIdx])}M</span>
                        <span>MAT: $${fmt(r[matIdx])}M</span>
                    </div>
                </div>
            `;
            label.title = r[1];
            label.onclick = (e) => showInitiativeDetail(e, r);

            const grid = document.createElement('div');
            grid.className = "gantt-grid-system h-[60px]";

            const cod = String(r[0]).trim();
            for (let i = 0; i < 12; i++) {
                const isDivider = [2, 5, 8].includes(i);
                const seg = document.createElement('div');
                seg.className = `line-segment ${isDivider ? 'border-r-2 border-slate-200 dark:border-slate-800/50 pr-1' : ''}`;

                const exp = parseFloat(r[33 + i]) || 0;
                const mat = parseFloat(r[67 + i]) || 0;
                const w = exp > 0 ? (mat / exp) * 100 : (mat > 0 ? 100 : 0);

                const dispE = exp > 0 ? (exp / 1e6).toFixed(1) + 'M' : '';
                const dispM = mat > 0 ? (mat / 1e6).toFixed(1) + 'M' : '';

                seg.innerHTML = `
                    ${dispE ? `<div class="gantt-value-top text-[10px] font-black">${dispE}</div>` : ''}
                    <div class="gantt-line-expected ${exp === 0 ? 'hidden' : ''}"></div>
                    <div class="gantt-line-materialized ${mat === 0 ? 'shaded' : ''}" style="width:${Math.min(w, 100)}%"></div>
                    ${dispM ? `<div class="gantt-value-bottom text-[10px] font-black">${dispM}</div>` : ''}
                `;

                const hitos = appData.milestones.filter(m => m[1] && String(m[1]).trim() === cod && m[3] && new Date(m[3]).getMonth() === i);
                hitos.forEach(m => {
                    const flag = document.createElement('div');
                    flag.className = "gantt-flag animate-bounce-subtle";
                    flag.innerHTML = "ðŸš©";
                    flag.onclick = (e) => { e.stopPropagation(); openHitosModal(cod, r[1]); };
                    seg.appendChild(flag);
                });

                grid.appendChild(seg);
            }

            row.appendChild(label); row.appendChild(grid);
            return row;
        }

        function renderSummaryRow(title, monthlyData, extraClasses = "") {
            const row = document.createElement('div');
            row.className = `gantt-row-container py-4 rounded-2xl ${extraClasses}`;

            const label = document.createElement('div');
            const isSubTotal = title.startsWith("SUB-TOTAL");
            label.className = `gantt-label-box font-black text-slate-500 dark:text-slate-400 uppercase tracking-widest leading-tight ${isSubTotal ? 'pl-20' : ''}`;
            label.innerText = title;

            const grid = document.createElement('div');
            grid.className = "gantt-grid-system";

            monthlyData.forEach((m, idx) => {
                const isDivider = [2, 5, 8].includes(idx);
                const cell = document.createElement('div');
                cell.className = `flex flex-col items-center justify-center gap-0.5 h-full ${isDivider ? 'border-r-2 border-slate-200 dark:border-slate-800' : ''}`;

                if (m.exp > 0 || m.mat > 0) {
                    cell.innerHTML = `
                        <span class="text-[9px] font-black text-indigo-500 leading-none">${m.exp > 0 ? '$' + fmt(m.exp) : '-'}</span>
                        <span class="text-[9px] font-black text-emerald-500 leading-none">${m.mat > 0 ? '$' + fmt(m.mat) : '-'}</span>
                    `;
                } else {
                    cell.innerHTML = '<span class="text-slate-300 dark:text-slate-700">-</span>';
                }
                grid.appendChild(cell);
            });

            row.appendChild(label); row.appendChild(grid);
            return row;
        }

        function toggleAccordion(contentId, iconId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(iconId);
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }

        function exportTableToPDF(elementId, filename) {
            const element = document.getElementById(elementId);
            const isDark = document.body.classList.contains('dark');

            showToast('Preparando exportaciÃ³n fluida...');

            // To ensure 100% column visibility and single page (no breaks)
            // We calculate the content height in mm to create a custom page size
            const widthPx = 1450;
            const heightPx = element.scrollHeight;
            const mmFactor = 0.264583; // px to mm at 96 DPI

            // Standard Landscape A4 width is 297mm. 
            // We use a custom format [width, height] to avoid page breaks.
            const pdfWidth = 297;
            const pdfHeight = (heightPx * (pdfWidth / widthPx)); // Scale height proportionally to fit width

            const opt = {
                margin: [5, 5, 5, 5],
                filename: `${filename}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: isDark ? '#0f172a' : '#ffffff',
                    windowWidth: widthPx,
                    scrollX: 0,
                    scrollY: 0
                },
                jsPDF: {
                    unit: 'mm',
                    format: [pdfWidth, pdfHeight],
                    orientation: 'landscape'
                }
            };

            const originalStyle = element.style.cssText;
            element.style.width = widthPx + 'px';
            element.style.overflow = 'visible';

            html2pdf().from(element).set(opt).toPdf().get('pdf').then(function (pdf) {
                element.style.cssText = originalStyle;
            }).save().then(() => {
                showToast('ExportaciÃ³n PDF (Horizontal) completada');
            }).catch(err => {
                element.style.cssText = originalStyle;
                showToast('Error: ' + err);
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            const icon = document.getElementById('sidebar-toggle-icon');
            if (sidebar.classList.contains('collapsed')) {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />';
            } else {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />';
            }
        }

        function showInitiativeDetail(e, r) {
            e.stopPropagation();
            const pop = document.getElementById('init-detail-popover');
            const rect = e.target.getBoundingClientRect();
            const containerRect = document.getElementById('views-container').getBoundingClientRect();

            // Position above the clicked element
            pop.style.display = 'block';
            // Use page coordinates to avoid scroll-related misalignment, 
            // but compensate for the offset parent since popover is absolute
            const scrollContainer = document.getElementById('views-container');
            const parentRect = pop.offsetParent.getBoundingClientRect();

            pop.style.left = `${rect.left - parentRect.left}px`;
            pop.style.top = `${rect.top - parentRect.top - pop.offsetHeight - 5}px`;

            document.getElementById('pop-init-name').innerText = r[1];
            // No longer updating POT/MAT in popover as requested

            const hitosList = document.getElementById('pop-init-hitos');
            hitosList.innerHTML = '';
            const cod = String(r[0]).trim();
            const milestones = appData.milestones.filter(m => String(m[1]).trim() === cod).slice(0, 3);
            if (milestones.length === 0) {
                hitosList.innerHTML = '<p class="text-[10px] text-slate-400 italic">No hay hitos registrados</p>';
            } else {
                milestones.forEach(m => {
                    const div = document.createElement('div');
                    div.className = "text-[10px]";
                    div.innerHTML = `<span class="font-black text-indigo-500 block">${m[3]}</span><span class="text-slate-500">${m[2]}</span>`;
                    hitosList.appendChild(div);
                });
            }
        }
        function renderInitCharts(filtered) {
            let q1E = 0, q2E = 0, q3E = 0, q4E = 0, q1M = 0, q2M = 0, q3M = 0, q4M = 0;
            const initMap = {};
            const potIdx = findIdx(['potencial ($)'], 18);
            filtered.forEach(row => {
                const name = row[1] || 'Sin Nombre';
                const pVal = parseFloat(String(row[potIdx]).replace(/[^0-9.-]+/g, "")) || 0;
                initMap[name] = (initMap[name] || 0) + pVal;
                q1E += parseFloat(row[51]) || 0; q2E += parseFloat(row[52]) || 0;
                q3E += parseFloat(row[53]) || 0; q4E += parseFloat(row[54]) || 0;
                q1M += parseFloat(row[85]) || 0; q2M += parseFloat(row[86]) || 0;
                q3M += parseFloat(row[87]) || 0; q4M += parseFloat(row[88]) || 0;
            });
            const labels = Object.keys(initMap).sort((a, b) => initMap[b] - initMap[a]).slice(0, 6);
            const pots = labels.map(l => initMap[l] / 1000000);
            const ctxQ = document.getElementById('init-quarter-chart').getContext('2d');
            const ctxP = document.getElementById('init-pie-chart').getContext('2d');
            if (initQChartInstance) initQChartInstance.destroy();
            if (initPieChartInstance) initPieChartInstance.destroy();
            const isDark = document.body.classList.contains('dark');
            const textColor = isDark ? '#f1f5f9' : '#1e293b';
            initQChartInstance = new Chart(ctxQ, {
                type: 'bar',
                data: {
                    labels: ['Q1', 'Q2', 'Q3', 'Q4', 'Total'],
                    datasets: [
                        { label: 'Esperado', data: [q1E, q2E, q3E, q4E, q1E + q2E + q3E + q4E].map(v => v / 1000000), backgroundColor: '#818cf8', borderRadius: 6 },
                        { label: 'Materializado', data: [q1M, q2M, q3M, q4M, q1M + q2M + q3M + q4M].map(v => v / 1000000), backgroundColor: '#10b981', borderRadius: 6 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'bottom', labels: { color: textColor } }, title: { display: true, text: 'Eficiencia Trimestral ($M)', color: textColor, font: { size: 12, weight: 'bold' } } }
                }
            });
            initPieChartInstance = new Chart(ctxP, {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: pots, backgroundColor: ['#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe', '#e0e7ff', '#f5f7ff'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: textColor, boxWidth: 12, font: { size: 10 } } }, title: { display: true, text: 'Potenciales por iniciativa', color: textColor, font: { size: 12, weight: 'bold' } } } }
            });
        }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.className = "show"; setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000); }
        function openModal(cod, name) { currentModalData = { codigo: cod, iniciativa: name }; document.getElementById('modal-subtitle').innerText = `${cod} â€¢ ${name}`; document.getElementById('obs-text').value = ''; document.getElementById('obs-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('obs-modal').classList.add('hidden'); }
        function saveObservation() {
            const text = document.getElementById('obs-text').value; if (!text.trim()) return showToast('Por favor escribe un seguimiento.');
            const p = { codigo: currentModalData.codigo, iniciativa: currentModalData.iniciativa, observacion: text };
            google.script.run.withSuccessHandler(() => { showToast('Â¡ObservaciÃ³n guardada con Ã©xito!'); closeModal(); }).withFailureHandler(e => showToast('Error: ' + e)).submitObservation(p);
        }
        function openHitosModal(cod, name) {
            const searchCod = String(cod || "").trim();
            const hitos = appData.milestones.filter(r => r && r[1] && String(r[1]).trim() == searchCod);
            const list = document.getElementById('hitos-list'); list.innerHTML = ''; document.getElementById('hitos-subtitle').innerText = `${cod} â€¢ ${name}`;
            if (hitos.length === 0) list.innerHTML = '<p class="text-slate-400 font-bold text-center py-10">No hay hitos registrados para esta iniciativa.</p>';
            else {
                hitos.forEach(h => {
                    const dateVal = h[3];
                    const isDone = h[4] === true || h[4] === "VERDADERO" || h[4] === "TRUE";
                    const statusText = isDone ? 'Completado' : 'Sin completar';
                    const statusClass = isDone ? 'bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400' : 'bg-rose-100 text-rose-600 dark:bg-rose-900/30 dark:text-rose-400';
                    const date = dateVal ? (isNaN(new Date(dateVal).getTime()) ? dateVal : new Date(dateVal).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' })) : 'Sin fecha';
                    const div = document.createElement('div'); div.className = "relative pl-10";
                    div.innerHTML = `<div class="absolute left-[-1px] top-1 h-8 w-8 rounded-full bg-indigo-600 border-4 border-white dark:border-slate-900 flex items-center justify-center z-10"><span class="text-white text-[10px]">ðŸš©</span></div><div class="bg-slate-50 dark:bg-slate-800/50 p-5 rounded-2xl border border-slate-100 dark:border-indigo-900/20 shadow-sm"><div class="flex justify-between items-center mb-2"><span class="text-[10px] font-black text-indigo-500 uppercase tracking-widest">${date}</span><span class="px-2 py-0.5 rounded-full text-[8px] font-black ${statusClass} uppercase">${statusText}</span></div><h4 class="font-bold text-slate-800 dark:text-white leading-tight">${h[2] || 'Sin tÃ­tulo'}</h4><p class="text-xs text-slate-500 mt-2">${h[0] || ''}</p></div>`;
                    list.appendChild(div);
                });
            }
            document.getElementById('hitos-modal').classList.remove('hidden');
        }
        function closeHitosModal() { document.getElementById('hitos-modal').classList.add('hidden'); }

        function openVpePdfModal() {
            const list = document.getElementById('vpe-selection-list');
            list.innerHTML = '';

            // Only show VPEs that are currently rendered in the container
            const renderedVpes = new Set();
            document.querySelectorAll('.vpe-gantt-vpe-header span:first-child').forEach(s => {
                renderedVpes.add(s.innerText.trim());
            });

            if (renderedVpes.size === 0) return showToast('No hay cronogramas visibles para exportar');

            Array.from(renderedVpes).sort().forEach(vpe => {
                const div = document.createElement('label');
                div.className = "flex items-center gap-3 p-4 bg-slate-50 dark:bg-slate-800/50 rounded-2xl cursor-pointer hover:bg-rose-50 dark:hover:bg-rose-900/20 transition-all group";
                div.innerHTML = `
                    <input type="radio" name="vpe-radio" value="${vpe}" class="w-5 h-5 rounded-full border-slate-300 text-rose-600 focus:ring-rose-500">
                    <span class="text-sm font-bold text-slate-700 dark:text-slate-200 group-hover:text-rose-600 transition-all">${vpe}</span>
                `;
                list.appendChild(div);
            });
            // Update modal title and button
            document.querySelector('#pdf-modal h3').innerText = 'Exportar Resumen PDF';
            document.querySelector('#pdf-modal p').innerText = 'Selecciona una VPE para exportar su reporte consolidado de iniciativas.';
            const genBtn = document.querySelector('#pdf-modal button[onclick*="generate"]');
            genBtn.innerText = 'Generar Reporte';
            genBtn.setAttribute('onclick', 'generatePDF()');
            genBtn.className = "px-8 py-3 bg-indigo-600 text-white text-xs font-black rounded-2xl shadow-lg hover:bg-indigo-700 transition-all uppercase tracking-widest";

            document.getElementById('pdf-modal').classList.remove('hidden');
        }

        function generatePDF() {
            const selectedRadio = document.querySelector('#vpe-selection-list input:checked');
            if (!selectedRadio) return showToast('Selecciona una VPE');
            const vpeName = selectedRadio.value.trim().toUpperCase();

            showToast('Generando PDF...');

            // Find the specific VPE group in the container
            const container = document.getElementById('vpe-gantt-container');
            const groups = container.querySelectorAll('.vpe-gantt-group');
            let targetGroup = null;
            groups.forEach(g => {
                const headSpan = g.querySelector('.vpe-gantt-vpe-header span');
                if (headSpan) {
                    const currentTitle = headSpan.innerText.trim().toUpperCase();
                    if (currentTitle === vpeName) targetGroup = g;
                }
            });

            if (!targetGroup) return showToast('No se encontrÃ³ el cronograma de ' + vpeName + '. AsegÃºrate de que los filtros permitan ver esta VPE.');

            // Use html2pdf for Direct PDF generation (Restore working logic)
            const opt = {
                margin: 0.3,
                filename: `EVA_${vpeName}_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    width: 1450,
                    backgroundColor: document.body.classList.contains('dark') ? '#020617' : '#ffffff'
                },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
            };

            // Clone to avoid style issues during capture and force width
            const clone = targetGroup.cloneNode(true);
            clone.style.width = '1450px';
            clone.style.padding = '40px';
            clone.style.backgroundColor = document.body.classList.contains('dark') ? '#020617' : '#ffffff';
            clone.style.color = document.body.classList.contains('dark') ? '#f1f5f9' : '#1e293b';

            html2pdf().from(clone).set(opt).save().then(() => {
                showToast('Reporte PDF generado');
                document.getElementById('pdf-modal').classList.add('hidden');
            });
        }

        function toggleDarkMode() { document.body.classList.toggle('dark'); buildVPEView(); buildInitiativesView(); }
    </script>
</body>

</html>
